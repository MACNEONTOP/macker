{
  "runtime": {
    "threat_score_1": {
      "type": "double",
      "script": {
        "source": "if (doc['kibana.alert.rule.tags'].size() > 0) { for (tag in doc['kibana.alert.rule.tags']) { if (tag.startsWith('threat_score_1:')) { emit(Double.parseDouble(tag.substring(15))) } } }"
      }
    },
    "threat_score_1_risk_level": {
      "type": "keyword",
      "script": {
        "source": "if (doc['kibana.alert.rule.tags'].size() > 0) { for (tag in doc['kibana.alert.rule.tags']) { if (tag.startsWith('threat_score_1_risk_level:')) { emit(tag.substring(26)) } } }"
      }
    },
    "threat_score_2": {
      "type": "double",
      "script": {
        "source": "if (doc['kibana.alert.rule.tags'].size() > 0) { for (tag in doc['kibana.alert.rule.tags']) { if (tag.startsWith('threat_score_2:')) { emit(Double.parseDouble(tag.substring(15))) } } }"
      }
    },
    "final_risk_score": {
      "type": "long",
      "script": {
        "source": "if (doc['kibana.alert.rule.tags'].size() > 0) { for (tag in doc['kibana.alert.rule.tags']) { if (tag.startsWith('final_risk_score:')) { emit(Long.parseLong(tag.substring(17))) } } }"
      }
    },
    "threat_score_1_risk_level_numeric": {
      "type": "long",
      "script": {
        "source": "if (doc['kibana.alert.rule.tags'].size() > 0) { for (tag in doc['kibana.alert.rule.tags']) { if (tag.startsWith('threat_score_1_risk_level:')) { String level = tag.substring(26); if (level.equals('CRITICAL')) emit(4); else if (level.equals('HIGH')) emit(3); else if (level.equals('MEDIUM')) emit(2); else if (level.equals('LOW')) emit(1); } } }"
      }
    },
    "name": {
    "type": "keyword",
    "script": {
        "source": "String h=null;if(doc.containsKey('host.name')&&!doc['host.name'].empty)h=doc['host.name'].value;else if(doc.containsKey('agent.name')&&!doc['agent.name'].empty)h=doc['agent.name'].value;else if(doc.containsKey('host.hostname')&&!doc['host.hostname'].empty)h=doc['host.hostname'].value;if(h==null&&doc.containsKey('kibana.alert.threshold_result.terms.value')){def v=doc['kibana.alert.threshold_result.terms.value'];for(int i=0;i<v.size();i++){String s=v[i].toString();for(int j=0;j<s.length();j++){if(Character.isLetter(s.charAt(j))){h=s;break;}}if(h!=null)break;}}if(h!=null)emit(h.toLowerCase());"
    }
}
  }
}
